<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Virtual Art Gallery 360°</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
        touch-action: none;
      }
      #app {
        position: relative;
        width: 100%;
        height: 100%;
      }
      #overlay {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 12px 16px;
        color: #fff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 13px;
        text-align: center;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10;
      }
      #overlay button {
        margin-top: 8px;
        padding: 8px 16px;
        border-radius: 999px;
        border: none;
        background: #fff;
        color: #000;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <script type="module">
      import * as THREE from 'https://unpkg.com/three@0.128.0/build/three.module.js';
      import { OrbitControls } from 'https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js';
      import { DeviceOrientationControls } from 'https://unpkg.com/three@0.128.0/examples/jsm/controls/DeviceOrientationControls.js';
      import { GLTFLoader } from 'https://unpkg.com/three@0.128.0/examples/jsm/loaders/GLTFLoader.js';

      const app = document.getElementById('app');

      const overlay = document.createElement('div');
      overlay.id = 'overlay';
      overlay.textContent = 'Loading gallery...';
      app.appendChild(overlay);

      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x111111);

      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.position.set(0, 1.6, 0);

      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      app.appendChild(renderer.domElement);

      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      let controls;
      let useDeviceOrientation = isMobile && 'DeviceOrientationEvent' in window;

      if (useDeviceOrientation) {
        controls = new DeviceOrientationControls(camera);
        overlay.textContent = 'Move your phone to look around the gallery in 360°';

        if (
          typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function'
        ) {
          const button = document.createElement('button');
          button.textContent = 'Enable Device Orientation';
          button.onclick = () => {
            DeviceOrientationEvent.requestPermission()
              .then((state) => {
                if (state === 'granted') {
                  overlay.textContent = 'Move your phone to look around the gallery in 360°';
                  if (!overlay.contains(button)) return;
                  overlay.removeChild(button);
                }
              })
              .catch(console.error);
          };
          overlay.appendChild(button);
        }
      } else {
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enableZoom = true;
        controls.enablePan = false;
        controls.minDistance = 0.5;
        controls.maxDistance = 10;
        overlay.textContent = 'Click and drag to look around • Scroll to zoom';
      }

      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(5, 10, 5);
      scene.add(directionalLight);

      const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
      directionalLight2.position.set(-5, 5, -5);
      scene.add(directionalLight2);

      const loader = new GLTFLoader();

      const loadModels = async () => {
        try {
          const galleryData = await loader.loadAsync(
            'https://pub-e46fd816b4ee497fb2f639f180c4df20.r2.dev/art_gallery.glb'
          );
          const gallery = galleryData.scene;
          scene.add(gallery);

          const whiteMeshData = await loader.loadAsync(
            'https://pub-e46fd816b4ee497fb2f639f180c4df20.r2.dev/white_mesh.glb'
          );

          const positions = [
            { x: 0, y: 0, z: -3, rotation: 0 },
            { x: 3, y: 0, z: 0, rotation: Math.PI / 2 },
            { x: 0, y: 0, z: 3, rotation: Math.PI },
            { x: -3, y: 0, z: 0, rotation: -Math.PI / 2 }
          ];

          positions.forEach((pos) => {
            const mesh = whiteMeshData.scene.clone();
            mesh.position.set(pos.x, pos.y, pos.z);
            mesh.rotation.y = pos.rotation;
            scene.add(mesh);
          });

          overlay.textContent += '';
        } catch (err) {
          console.error('Error loading models:', err);
          overlay.textContent = 'Failed to load 3D models. Please check your network.';
        }
      };

      loadModels();

      const onWindowResize = () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      };

      window.addEventListener('resize', onWindowResize);

      const animate = () => {
        requestAnimationFrame(animate);
        if (controls && controls.update) controls.update();
        renderer.render(scene, camera);
      };

      animate();
    </script>
  </body>
</html>
