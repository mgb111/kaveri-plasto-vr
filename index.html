<!DOCTYPE html>
<html>
<head>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
import React, { useEffect, useRef, useState } from 'react';
import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls';
import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader';
import { DeviceOrientationControls } from 'three/examples/jsm/controls/DeviceOrientationControls';

const ArtGallery360 = () => {
  const containerRef = useRef(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [isMobile, setIsMobile] = useState(false);

  useEffect(() => {
    // Check if mobile
    const checkMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    setIsMobile(checkMobile);

    let scene, camera, renderer, controls;
    let gallery, whiteMeshes = [];

    const init = async () => {
      // Scene setup
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x111111);

      // Camera setup - positioned in center of gallery
      camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.position.set(0, 1.6, 0); // Eye level height

      // Renderer setup
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      containerRef.current.appendChild(renderer.domElement);

      // Controls
      if (checkMobile && window.DeviceOrientationEvent) {
        // Try to use device orientation for mobile
        controls = new DeviceOrientationControls(camera);
      } else {
        // Use orbit controls for desktop or fallback
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enableZoom = true;
        controls.enablePan = false;
        controls.minDistance = 0.5;
        controls.maxDistance = 10;
      }

      // Lighting
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(5, 10, 5);
      scene.add(directionalLight);

      const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
      directionalLight2.position.set(-5, 5, -5);
      scene.add(directionalLight2);

      // Load models
      const loader = new GLTFLoader();

      try {
        // Load gallery
        const galleryData = await loader.loadAsync(
          'https://pub-e46fd816b4ee497fb2f639f180c4df20.r2.dev/art_gallery.glb'
        );
        gallery = galleryData.scene;
        scene.add(gallery);

        // Load white mesh model
        const whiteMeshData = await loader.loadAsync(
          'https://pub-e46fd816b4ee497fb2f639f180c4df20.r2.dev/white_mesh.glb'
        );

        // Position white mesh on 4 walls
        // Assuming the gallery is roughly centered at origin
        const positions = [
          { x: 0, y: 0, z: -3, rotation: 0 },      // North wall
          { x: 3, y: 0, z: 0, rotation: Math.PI / 2 },   // East wall
          { x: 0, y: 0, z: 3, rotation: Math.PI },  // South wall
          { x: -3, y: 0, z: 0, rotation: -Math.PI / 2 } // West wall
        ];

        positions.forEach((pos, index) => {
          const mesh = whiteMeshData.scene.clone();
          mesh.position.set(pos.x, pos.y, pos.z);
          mesh.rotation.y = pos.rotation;
          scene.add(mesh);
          whiteMeshes.push(mesh);
        });

        setLoading(false);
      } catch (err) {
        console.error('Error loading models:', err);
        setError('Failed to load 3D models. Please check the URLs.');
        setLoading(false);
      }

      // Animation loop
      const animate = () => {
        requestAnimationFrame(animate);
        
        if (controls.update) {
          controls.update();
        }
        
        renderer.render(scene, camera);
      };
      animate();

      // Handle window resize
      const handleResize = () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      };
      window.addEventListener('resize', handleResize);

      // Cleanup
      return () => {
        window.removeEventListener('resize', handleResize);
        renderer.dispose();
        if (containerRef.current && renderer.domElement) {
          containerRef.current.removeChild(renderer.domElement);
        }
      };
    };

    init();
  }, []);

  // Request permission for device orientation on iOS
  const requestPermission = () => {
    if (typeof DeviceOrientationEvent !== 'undefined' && 
        typeof DeviceOrientationEvent.requestPermission === 'function') {
      DeviceOrientationEvent.requestPermission()
        .then(permissionState => {
          if (permissionState === 'granted') {
            window.location.reload();
          }
        })
        .catch(console.error);
    }
  };

  return (
    <div className="relative w-full h-screen bg-black">
      <div ref={containerRef} className="w-full h-full" />
      
      {loading && (
        <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-80">
          <div className="text-white text-center">
            <div className="mb-4">Loading Gallery...</div>
            <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mx-auto"></div>
          </div>
        </div>
      )}

      {error && (
        <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-80">
          <div className="text-red-500 text-center p-4">
            {error}
          </div>
        </div>
      )}

      {isMobile && !loading && (
        <div className="absolute bottom-4 left-4 right-4 text-white text-center text-sm bg-black bg-opacity-50 p-3 rounded">
          Move your phone to look around the gallery in 360°
          {typeof DeviceOrientationEvent !== 'undefined' && 
           typeof DeviceOrientationEvent.requestPermission === 'function' && (
            <button 
              onClick={requestPermission}
              className="mt-2 px-4 py-2 bg-white text-black rounded block mx-auto"
            >
              Enable Device Orientation
            </button>
          )}
        </div>
      )}

      {!isMobile && !loading && (
        <div className="absolute bottom-4 left-4 right-4 text-white text-center text-sm bg-black bg-opacity-50 p-3 rounded">
          Click and drag to look around • Scroll to zoom
        </div>
      )}
    </div>
  );
};

export default ArtGallery360;
</head>
<body>
  <div id="root"></div>
</body>
</html>
