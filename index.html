<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Virtual Art Gallery 360°</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
        touch-action: none;
      }
      #app {
        position: relative;
        width: 100%;
        height: 100%;
      }
      #overlay {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 12px 16px;
        color: #fff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 13px;
        text-align: center;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0));
        z-index: 10;
      }
      #overlay button {
        margin-top: 8px;
        padding: 8px 16px;
        border-radius: 999px;
        border: none;
        background: #fff;
        color: #000;
        font-weight: 600;
      }
      #fullscreen-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 11;
        padding: 8px 10px;
        border-radius: 999px;
        border: none;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      #fullscreen-btn span {
        font-size: 14px;
      }
      #brand-logo {
        position: absolute;
        top: 12px;
        left: 12px;
        z-index: 11;
        height: 40px;
        width: auto;
        object-fit: contain;
      }
      #product-panel {
        position: absolute;
        top: 64px;
        left: 12px;
        max-width: 260px;
        padding: 8px 10px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.55);
        color: #fff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 11px;
        line-height: 1.4;
        z-index: 11;
      }
      #product-panel h2 {
        margin: 0 0 4px;
        font-size: 12px;
        font-weight: 600;
      }
      #product-panel ul {
        margin: 0;
        padding-left: 16px;
        list-style: disc;
      }
      #product-panel li {
        margin-bottom: 2px;
      }
      #current-product {
        margin-top: 6px;
        padding-top: 4px;
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        font-size: 11px;
        opacity: 0.9;
      }
      #zoom-controls {
        position: absolute;
        right: 12px;
        bottom: 72px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        z-index: 11;
      }
      #zoom-controls button {
        width: 40px;
        height: 32px;
        border-radius: 999px;
        border: none;
        background: rgba(0, 0, 0, 0.65);
        color: #fff;
        font-size: 16px;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/DeviceOrientationControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script>
      const app = document.getElementById('app');

      const overlay = document.createElement('div');
      overlay.id = 'overlay';
      overlay.textContent = 'Loading gallery...';
      app.appendChild(overlay);

      const brandLogo = document.createElement('img');
      brandLogo.id = 'brand-logo';
      brandLogo.src = 'https://pub-e46fd816b4ee497fb2f639f180c4df20.r2.dev/kaveri-logo-1.png';
      brandLogo.alt = 'Kaveri Plasto';
      app.appendChild(brandLogo);

      const productPanel = document.createElement('div');
      productPanel.id = 'product-panel';
      productPanel.innerHTML = `
        <h2>Product Info</h2>
        <div id="current-product">Tap or click a product to see details.</div>
      `;
      app.appendChild(productPanel);

      const currentProductLabel = document.getElementById('current-product');

      const zoomControls = document.createElement('div');
      zoomControls.id = 'zoom-controls';
      zoomControls.innerHTML = `
        <button id="zoom-in">+</button>
        <button id="zoom-out">-</button>
      `;
      app.appendChild(zoomControls);

      const fullscreenBtn = document.createElement('button');
      fullscreenBtn.id = 'fullscreen-btn';
      fullscreenBtn.innerHTML = '<span>⤢</span> Fullscreen';
      fullscreenBtn.onclick = () => {
        const element = document.documentElement;
        if (!document.fullscreenElement) {
          if (element.requestFullscreen) element.requestFullscreen();
        } else {
          if (document.exitFullscreen) document.exitFullscreen();
        }
      };
      app.appendChild(fullscreenBtn);

      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x111111);

      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.position.set(0, 1.6, 0);

      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
      renderer.setSize(window.innerWidth, window.innerHeight);
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const maxPixelRatio = isMobile ? 1.5 : 2;
      renderer.setPixelRatio(Math.min(maxPixelRatio, window.devicePixelRatio));
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      app.appendChild(renderer.domElement);

      let controls;
      let useDeviceOrientation = isMobile && 'DeviceOrientationEvent' in window;

      const raycaster = new THREE.Raycaster();
      const pointer = new THREE.Vector2();
      const selectableObjects = [];

      if (useDeviceOrientation) {
        controls = new THREE.DeviceOrientationControls(camera);
        overlay.textContent = 'Move your phone to look around the gallery in 360°';

        if (
          typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function'
        ) {
          const button = document.createElement('button');
          button.textContent = 'Enable Device Orientation';
          button.onclick = () => {
            DeviceOrientationEvent.requestPermission()
              .then((state) => {
                if (state === 'granted') {
                  overlay.textContent = 'Move your phone to look around the gallery in 360°';
                  if (!overlay.contains(button)) return;
                  overlay.removeChild(button);
                }
              })
              .catch(console.error);
          };
          overlay.appendChild(button);
        }
      } else {
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enableZoom = true;
        controls.enablePan = false;
        controls.minDistance = 0.5;
        controls.maxDistance = 10;
        controls.minPolarAngle = Math.PI * 0.2;
        controls.maxPolarAngle = Math.PI * 0.8;
        // Start from center, looking towards Product 1 on the front wall (z negative)
        controls.target.set(0, 1.2, -3);
        controls.update();
        overlay.textContent = 'Click and drag to look around • Scroll to zoom';
      }

      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(5, 10, 5);
      scene.add(directionalLight);

      const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
      directionalLight2.position.set(-5, 5, -5);
      scene.add(directionalLight2);

      const loader = new THREE.GLTFLoader();
      const textureLoader = new THREE.TextureLoader();
      const productMeshes = [];

      const createLabelSprite = (text) => {
        const canvas = document.createElement('canvas');
        canvas.width = 256;
        canvas.height = 64;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#ffffff';
        ctx.font = '20px system-ui';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, canvas.width / 2, canvas.height / 2);

        const texture = new THREE.CanvasTexture(canvas);
        const material = new THREE.SpriteMaterial({ map: texture, transparent: true });
        const sprite = new THREE.Sprite(material);
        sprite.scale.set(1.2, 0.3, 1);
        return sprite;
      };

      const loadModels = async () => {
        try {
          const loadGLTF = (url) =>
            new Promise((resolve, reject) => {
              loader.load(url, (gltf) => resolve(gltf), undefined, reject);
            });

          const galleryData = await loadGLTF(
            'https://pub-e46fd816b4ee497fb2f639f180c4df20.r2.dev/art_gallery.glb'
          );
          const gallery = galleryData.scene;
          scene.add(gallery);

          const whiteMeshData = await loadGLTF(
            'https://pub-e46fd816b4ee497fb2f639f180c4df20.r2.dev/white_mesh.glb'
          );

          const logoTexture = textureLoader.load(
            'https://pub-e46fd816b4ee497fb2f639f180c4df20.r2.dev/kaveri-logo-1.png'
          );
          const brandingMaterial = new THREE.MeshBasicMaterial({
            map: logoTexture,
            transparent: true,
            side: THREE.DoubleSide,
          });

          const positions = [
            { x: 0, y: 1.2, z: -3, rotation: 0, label: 'Product 1' },
            { x: 3, y: 1.2, z: 0, rotation: Math.PI / 2, label: 'Product 2' },
            { x: 0, y: 1.2, z: 3, rotation: Math.PI, label: 'Product 3' },
            { x: -3, y: 1.2, z: 0, rotation: -Math.PI / 2, label: 'Product 4' }
          ];

          positions.forEach((pos, index) => {
            const mesh = whiteMeshData.scene.clone();
            mesh.position.set(pos.x, pos.y, pos.z);
            mesh.rotation.y = pos.rotation;
            scene.add(mesh);
            productMeshes.push(mesh);

            selectableObjects.push(mesh);

            const labelSprite = createLabelSprite(pos.label);
            labelSprite.position.set(pos.x, pos.y + 0.6, pos.z);
            scene.add(labelSprite);

            // Add a flat branding panel with the Kaveri logo attached to the front of each product
            const panelGeom = new THREE.PlaneGeometry(1.3, 0.55);
            const panel = new THREE.Mesh(panelGeom, brandingMaterial);
            // Attach to mesh so it always sits on the front face
            mesh.add(panel);
            panel.position.set(0, 0.25, 0.35); // centered on front face
          });
          if (isMobile) {
            overlay.textContent = 'Move your phone slowly to look around the gallery in 360°';
          } else {
            overlay.textContent = 'Click and drag to look around • Scroll to zoom';
          }
        } catch (err) {
          console.error('Error loading models:', err);
          overlay.textContent = 'Failed to load 3D models. Please check your network.';
        }
      };

      loadModels();

      const onWindowResize = () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      };

      window.addEventListener('resize', onWindowResize);
      const dir = new THREE.Vector3();

      const moveState = { forward: false, back: false, left: false, right: false };
      const moveSpeed = 2.0;

      const onKeyChange = (event, isDown) => {
        switch (event.code) {
          case 'KeyW':
          case 'ArrowUp':
            moveState.forward = isDown;
            break;
          case 'KeyS':
          case 'ArrowDown':
            moveState.back = isDown;
            break;
          case 'KeyA':
          case 'ArrowLeft':
            moveState.left = isDown;
            break;
          case 'KeyD':
          case 'ArrowRight':
            moveState.right = isDown;
            break;
        }
      };

      window.addEventListener('keydown', (e) => onKeyChange(e, true));
      window.addEventListener('keyup', (e) => onKeyChange(e, false));

      const zoomInBtn = document.getElementById('zoom-in');
      const zoomOutBtn = document.getElementById('zoom-out');
      const minFov = 35;
      const maxFov = 90;

      const applyZoomDelta = (delta) => {
        camera.fov = THREE.MathUtils.clamp(camera.fov + delta, minFov, maxFov);
        camera.updateProjectionMatrix();
      };

      zoomInBtn.addEventListener('click', () => applyZoomDelta(-5));
      zoomOutBtn.addEventListener('click', () => applyZoomDelta(5));

      const productDescriptions = {
        1: 'Heavy-duty plastic container for industrial liquids.',
        2: 'Stackable storage drum for bulk materials.',
        3: 'Food-grade container for oils and consumables.',
        4: 'Compact multi-purpose plastic can for retail use.'
      };

      const updateSelectedProductInfo = (index) => {
        const id = index + 1;
        currentProductLabel.textContent = `Product ${id}: ${productDescriptions[id]}`;
      };

      const handlePointerFromEvent = (event) => {
        const rect = renderer.domElement.getBoundingClientRect();
        const clientX = event.touches ? event.touches[0].clientX : event.clientX;
        const clientY = event.touches ? event.touches[0].clientY : event.clientY;
        pointer.x = ((clientX - rect.left) / rect.width) * 2 - 1;
        pointer.y = -((clientY - rect.top) / rect.height) * 2 + 1;
      };

      const onSelect = (event) => {
        handlePointerFromEvent(event);
        raycaster.setFromCamera(pointer, camera);
        const intersects = raycaster.intersectObjects(selectableObjects, true);
        if (intersects.length > 0) {
          const meshIndex = productMeshes.indexOf(intersects[0].object.parent || intersects[0].object);
          if (meshIndex >= 0) {
            updateSelectedProductInfo(meshIndex);
          }
        }
      };

      renderer.domElement.addEventListener('click', onSelect);
      renderer.domElement.addEventListener('touchend', (e) => {
        if (e.touches && e.touches.length > 0) return;
        onSelect(e.changedTouches ? e.changedTouches[0] : e);
      });

      // Pinch-to-zoom on mobile
      let activeTouches = [];
      let initialPinchDistance = 0;

      const getDistance = (t1, t2) => {
        const dx = t1.clientX - t2.clientX;
        const dy = t1.clientY - t2.clientY;
        return Math.sqrt(dx * dx + dy * dy);
      };

      const onTouchStart = (e) => {
        if (e.touches.length === 2) {
          activeTouches = [e.touches[0], e.touches[1]];
          initialPinchDistance = getDistance(activeTouches[0], activeTouches[1]);
        }
      };

      const onTouchMove = (e) => {
        if (e.touches.length === 2 && initialPinchDistance > 0) {
          const d = getDistance(e.touches[0], e.touches[1]);
          const delta = initialPinchDistance - d;
          if (Math.abs(delta) > 2) {
            applyZoomDelta(delta > 0 ? 1 : -1);
            initialPinchDistance = d;
          }
        }
      };

      const onTouchEnd = (e) => {
        if (e.touches.length < 2) {
          initialPinchDistance = 0;
        }
      };

      renderer.domElement.addEventListener('touchstart', onTouchStart, { passive: true });
      renderer.domElement.addEventListener('touchmove', onTouchMove, { passive: true });
      renderer.domElement.addEventListener('touchend', onTouchEnd);

      const updateCurrentProduct = () => {
        camera.getWorldDirection(dir);
        const angle = Math.atan2(dir.x, dir.z); // -PI to PI, z-forward

        let product = 1;
        // Front (z negative): Product 1
        // Right (x positive): Product 2
        // Back (z positive): Product 3
        // Left (x negative): Product 4
        if (angle > -Math.PI / 4 && angle <= Math.PI / 4) {
          product = 3;
        } else if (angle > Math.PI / 4 && angle <= (3 * Math.PI) / 4) {
          product = 2;
        } else if (angle <= -Math.PI / 4 && angle > (-3 * Math.PI) / 4) {
          product = 4;
        } else {
          product = 1;
        }

        if (!Number.isNaN(product)) {
          currentProductLabel.textContent = `Currently viewing: Product ${product}`;
        }
      };
      const clock = new THREE.Clock();

      const animate = () => {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();

        if (moveState.forward || moveState.back || moveState.left || moveState.right) {
          const moveDir = new THREE.Vector3();
          camera.getWorldDirection(moveDir);
          moveDir.y = 0;
          moveDir.normalize();
          const right = new THREE.Vector3().crossVectors(moveDir, new THREE.Vector3(0, 1, 0)).normalize();

          let moveVector = new THREE.Vector3();
          if (moveState.forward) moveVector.add(moveDir);
          if (moveState.back) moveVector.sub(moveDir);
          if (moveState.left) moveVector.sub(right);
          if (moveState.right) moveVector.add(right);

          if (moveVector.lengthSq() > 0) {
            moveVector.normalize().multiplyScalar(moveSpeed * delta);
            camera.position.add(moveVector);
            if (controls && controls.target) {
              controls.target.add(moveVector);
            }
          }
        }

        if (controls && controls.update) controls.update();
        updateCurrentProduct();
        renderer.render(scene, camera);
      };

      animate();
    </script>
  </body>
</html>
